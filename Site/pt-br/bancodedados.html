<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acompanhe</title>
    <link rel="shortcut icon" href="icone.ico">
    <link rel="stylesheet" href="inicialcss.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
    <script src="http://www.chartjs.org/samples/latest/utils.js"></script>
    
</head>

<body class="body2">


    <div class="menutopo">
        <div class="container">

            <img class="headerlogo" src="logo.png">
        </div>

        <span class="textolink"><a class="acor" href="inicial.html">Home</a>
            <a href="quemsomos.html">Quem Somos</a>
            <a class="acor" href="calculadora.html">Simule</a>
            <a class="acor" href="contatos.html">Fale Conosco </a>
            <a href="inicial1.html" onclick="deslogar()" style="float: right;">Sair</a>
        </span>
    </div>


    <div class="caixatextobaixo">

        <div>
            <h1>Sensor DHT 11 - Umidade</h1>
            <br>
            <section>
                <h2>
                    <div class="div_valores">

                        <div class="nome">Status: </div><div class="status" id="status_umid" style="background-color: green; text-align: left;"><span id="realtime_umid"></span>%</div>
                        <div class="nome">Média: </div><div class="status" id="" style="background-color: gray; text-align: left;"><span id='average'>0.00</span>%</div>
                        <div class="nome">Mediana: </div><div class="status" id="" style="background-color: gray; text-align: left;"><span id='mediana_umid'>0.00</span></div>
                        <div class="nome">1° Quartil: </div><div class="status" id="" style="background-color: gray; text-align: left;"><span id='1quartil_umid'>0.00</span></h2>
                    </div>

            </section>
            <div>
                <section class="graf1">
                    <canvas id="chart" style="height:40vh; width:80vw"></canvas>
                </section>
                <br><br>
                <h1>Sensor DHT 11 - Temperatura</h1>
                <br>
                <section>
                    <h2>
                        <div class="div_valores">

                            <div class="nome">Status: </div><div class="status" id="status_temp" style="background-color: green; text-align: left;"><span id="realtime_temp"></span>°C</div>
                            <div class="nome">Média: </div><div class="status" id="" style="background-color: gray; text-align: left;"><span id='average2'>0.00</span>°C</div>
                            <div class="nome">Mediana: </div><div class="status" id="" style="background-color: gray; text-align: left;"><span id='mediana_temp'>0.00</span></div>
                            <div class="nome">1° Quartil: </div><div class="status" id="" style="background-color: gray; text-align: left;"><span id='1quartil_temp'>0.00</span></div>
                        </h2>
                        </div>
                </section>
                <section class="graf2">
                    <canvas id="chart2"></canvas>
                </section>
                <br><br>
            </div>
            <br><br><br>
        </div>

</body>

</html>
<script>

var cont = 0;
var temp = [];
var umi = [];
var mediatemp = [];
var mediaumi = [];
var esq_umi = 0;
var dir_umi = 0;
var meio_umi = 0;
var esq_temp = 0;
var dir_temp = 0;
var meio_temp = 0;

    var context = document.getElementById("chart").getContext("2d");
    context.canvas.width = 1000;
    context.canvas.height = 300;

    var configuration = {
        type: 'line',
        data: {
            datasets: [{
                label: "Umidade (%)",
                type: 'line',
                borderColor: ['#eb3a34'],
                backgroundColor: ['#eb3a3400']
            }]
        },
        options: {
            scales: {
                xAxes: [{
                    distribution: 'series',
                    ticks: {
                        beginAtZero: true
                    }
                }],
                yAxes: [{
                    scaleLabel: {
                        display: true,
                        labelString: 'Umidade (%)'
                    },
                    ticks: {
                        beginAtZero: true
                    }
                }]
            },
            animation: {
                duration: 0
            }
        }
    };

    var chart = new Chart(context, configuration);
    this.lastIndexTemp = 0;
    this.time = 0;

    function get_data() {

        var http = new XMLHttpRequest();
        http.open('GET', 'http://localhost:3000/api', false);
        http.send(null);

        var obj = JSON.parse(http.responseText);
        if (obj.data.length == 0) {
            return;
        }

        

        var _lastIndexTemp = this.lastIndexTemp;
        this.lastIndexTemp = obj.data.length;
        listTemp = obj.data.slice(_lastIndexTemp);

        listTemp.forEach(data => {
            if (chart.data.labels.length == 10 && chart.data.datasets[0].data.length == 10) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }

            chart.data.labels.push(this.time++);
            chart.data.datasets[0].data.push(parseFloat(data[0]));
            chart.update();
        });


        
        listTemp.forEach(data => {
            if (chart2.data.labels.length == 10 && chart2.data.datasets[0].data.length == 10) {
                chart2.data.labels.shift();
                chart2.data.datasets[0].data.shift();
            }

            chart2.data.labels.push(this.time++);
            chart2.data.datasets[0].data.push(parseFloat(data[1]));
            chart2.update();
            
        });


        listTemp.forEach(data => {
            cont+=2;
            
            document.getElementById('realtime_temp').textContent = data[1];
            document.getElementById('realtime_umid').textContent = data[0];
        for (let i = 0; i <= 1; i++){
            
            temp.push(parseFloat(data[1]));
            umi.push(parseFloat(data[0]));
        }
        console.log(temp[0]);
        console.log(umi[0]);
        let sum = umi.reduce((a, b) => a + b);
        let sum2 = temp.reduce((a, b) => a + b);
        
        
        mediaumi = sum / cont;
        mediatemp = sum2 / cont;
        document.getElementById('average').textContent = mediaumi.toFixed(1);
        document.getElementById('average2').textContent = mediatemp.toFixed(1);
        
        dir_temp = temp.length-1;
        esq_temp = temp[0];
        meio_temp = (dir_temp + esq_temp)/2;    
    
        dir_umi = temp.length-1;
        esq_umi = temp[0];
        meio_umi = (dir_umi + esq_umi)/2;    
        
        document.getElementById('mediana_umid').textContent = umi[meio_umi];
        document.getElementById('mediana_temp').textContent = temp[meio_temp];
    });
    
    
    
    
    
        
        
    }
    



    setInterval(() => {
        get_data();
    }, 1000);
    

    var context2 = document.getElementById("chart2").getContext("2d");
    context2.canvas.width = 1000;
    context2.canvas.height = 300;

    var configuration2 = {
        type: 'line',
        data: {
            datasets: [{
                label: "Temperatura (°C)",
                type: 'line',
                borderColor: ['#34baeb'],
                backgroundColor: ['#34baeb00']
            }]
        },
        options: {
            scales: {
                xAxes: [{
                    distribution: 'series',
                    ticks: {
                        beginAtZero: true
                    }
                }],
                yAxes: [{
                    scaleLabel: {
                        display: true,
                        labelString: 'Temperatura (°C)'
                    },
                    ticks: {
                        beginAtZero: true
                    }
                }]
            },
            animation: {
                duration: 0
            }
        }
    };

    var chart2 = new Chart(context2, configuration2);
function testes(){
    if (temp[0] >= 24.5){
        document.getElementById('status_temp').style.backgroundColor = 'red';
    }else{
        if(temp[0] >= 23.5){
            document.getElementById('status_temp').style.backgroundColor = 'orange';
        }else{
            if (temp[0] < 23.5 && temp[0] > 21){
                document.getElementById('status_temp').style.backgroundColor = 'yellow';
            }else{
                if (temp[0] < 19 && temp[0] > 16.5){
                    document.getElementById('status_temp').style.backgroundColor = 'yellow';
                }else{
                    if (temp[0] <= 16.5 && temp[0] > 15.5){
                        document.getElementById('status_temp').style.backgroundColor = 'orange';
                    }else{
                        if (temp[0] <= 15.5){
                            document.getElementById('status_temp').style.backgroundColor = 'red';
                         }else{
                             if (temp[0] >= 19 && temp[0] <= 21){
                                document.getElementById('status_temp').style.backgroundColor = 'green';
                             }
                         }
                    }
                }
            }
        }
    }
    
    if (umi[0] >= 16.2){
        document.getElementById('status_umid').style.backgroundColor = 'red';
    }else{
        if(umi[0] >= 14.2){
            document.getElementById('status_umid').style.backgroundColor = 'orange';
        }else{
            if (umi[0] < 14.2 && umi[0] > 11.2){
                document.getElementById('status_umid').style.backgroundColor = 'yellow';
            }else{
                if (umi[0] < 10.8 && umi[0] > 7.8){
                    document.getElementById('status_umid').style.backgroundColor = 'yellow';
                }else{
                    if (umi[0] <= 7.8 && umi[0] > 5.8){
                        document.getElementById('status_umid').style.backgroundColor = 'orange';
                    }else{
                        if (umi[0] <= 5.8){
                            document.getElementById('status_umid').style.backgroundColor = 'red';
                         }else{
                             if (umi[0] >= 10.8 && umi[0] <= 11.2){
                                 document.getElementById('status_umid').style.backgroundColor = 'green';
                                }
                            }
                        }
                    }
                }
        }
    }
}
setInterval(() => {
        testes();
    }, 10);
</script>